<!DOCTYPE html><html class="theme-next mist use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><script src="/lib/pace/pace.min.js?v=1.0.2"></script><link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet"><script></script><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="baidu-site-verification" content="WIIeufYjj6"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="https://fonts.cat.net/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|monospace:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="keywords" content="Hexo, NexT"><link rel="alternate" href="/atom.xml" title="Winddoing's Blog" type="application/atom+xml"><meta name="description" content="程序员的自我修养  链接、装载与库   温故而知新内存不够怎么办 任何将计算机上有限的物理内存分配给多个程序使用  如果采用直接使用物理内存空间执行程序,存在一下问题:  地址空间不隔离  所有程序直接访问物理地址,程序所使用的内存空间不是相互隔离的,程序容易被有意或者无意的修改,使其崩溃.   内存使用率低  整个程序都加载到内存中占用大量空间,执行新的程序空间不足时,也需要换入换出大量数据."><meta name="keywords" content="Hexo, NexT, Winddoing,嵌入式,Linux,shell,C语言,网络， 个人博客，专注嵌入式系统开发， mips"><meta property="og:type" content="website"><meta property="og:title" content="程序员的自我修养"><meta property="og:url" content="http://winddoing.github.io/books/程序员的自我修养/index.html"><meta property="og:site_name" content="Winddoing&#39;s Blog"><meta property="og:description" content="程序员的自我修养  链接、装载与库   温故而知新内存不够怎么办 任何将计算机上有限的物理内存分配给多个程序使用  如果采用直接使用物理内存空间执行程序,存在一下问题:  地址空间不隔离  所有程序直接访问物理地址,程序所使用的内存空间不是相互隔离的,程序容易被有意或者无意的修改,使其崩溃.   内存使用率低  整个程序都加载到内存中占用大量空间,执行新的程序空间不足时,也需要换入换出大量数据."><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="http://winddoing.github.io/images/2018/12/page_fault_flow.png"><meta property="og:image" content="http://winddoing.github.io/images/2018/12/gcc编译过程.png"><meta property="og:updated_time" content="2019-02-26T07:26:40.422Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="程序员的自我修养"><meta name="twitter:description" content="程序员的自我修养  链接、装载与库   温故而知新内存不够怎么办 任何将计算机上有限的物理内存分配给多个程序使用  如果采用直接使用物理内存空间执行程序,存在一下问题:  地址空间不隔离  所有程序直接访问物理地址,程序所使用的内存空间不是相互隔离的,程序容易被有意或者无意的修改,使其崩溃.   内存使用率低  整个程序都加载到内存中占用大量空间,执行新的程序空间不足时,也需要换入换出大量数据."><meta name="twitter:image" content="http://winddoing.github.io/images/2018/12/page_fault_flow.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Mist",version:"5.1.4",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!1,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"Winddoing"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://winddoing.github.io/books/程序员的自我修养/"><title>程序员的自我修养 | Winddoing's Blog</title><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?38fa95924670925239ef842cb0c8722b";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Winddoing's Blog</span><span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">Follow Excellent, Success will Chase you</h1></div><div class="site-nav-toggle"> <button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br> 首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br> 归档</a></li><li class="menu-item menu-item-download"><a href="/downloads/" rel="section"><i class="menu-item-icon fa fa-fw fa-tasks"></i><br> 下载</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br> 关于</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br> 搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"> <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav><script>!function(e,t,o,c,i,a,n){e.DaoVoiceObject=i,e[i]=e[i]||function(){(e[i].q=e[i].q||[]).push(arguments)},e[i].l=1*new Date,a=t.createElement(o),n=t.getElementsByTagName(o)[0],a.async=1,a.src=c,a.charset="utf-8",n.parentNode.insertBefore(a,n)}(window,document,"script",("https:"==document.location.protocol?"https:":"http:")+"//widget.daovoice.io/widget/0f81ff2f.js","daovoice"),daovoice("init",{app_id:"a28f1641"}),daovoice("update")</script></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><div class="post-block page"><header class="post-header"><h2 class="post-title" itemprop="name headline">程序员的自我修养</h2></header><div class="post-body"><blockquote class="blockquote-center"><p>程序员的自我修养 链接、装载与库</p></blockquote><h1 id="温故而知新"><a href="#温故而知新" class="headerlink" title="温故而知新"></a>温故而知新</h1><h2 id="内存不够怎么办"><a href="#内存不够怎么办" class="headerlink" title="内存不够怎么办"></a>内存不够怎么办</h2><blockquote><p>任何将计算机上有限的物理内存分配给多个程序使用</p></blockquote><p>如果采用直接使用物理内存空间执行程序,存在一下问题:</p><ol><li><p>地址空间不隔离</p><blockquote><p>所有程序直接访问物理地址,程序所使用的内存空间不是相互隔离的,程序容易被有意或者无意的修改,使其崩溃.</p></blockquote></li><li><p>内存使用率低</p><blockquote><p>整个程序都加载到内存中占用大量空间,执行新的程序空间不足时,也需要换入换出大量数据.</p></blockquote></li><li><p>程序运行地址不确定</p><blockquote><p>程序在编写时,其实是编译成可执行文件时,它访问数据和指令跳转时的目的地址很多都是固定的,地址不确定会造成很大麻烦.</p></blockquote></li></ol><p> <strong>解决方法: <code>增加中间层</code></strong> 使用一种间接的地址访问方法 — <code>虚拟地址(Virtual Address)</code></p><p>把程序给出的地址看作是一种虚拟地址,然后通过某些映射方法,将这个虚拟地址转换成实际的物理地址.</p><h2 id="隔离"><a href="#隔离" class="headerlink" title="隔离"></a>隔离</h2><p>地址空间: 所谓地址空间是个比较抽象的概念,你可以把它想象成一个很大的数组,每个数组的元素是一个字节,而这个数组大小由地址空间的地址长度(地址线的个数)决定,比如32位地址空间大小为2^32=4 294 967 296字节,即4G</p><p>虚拟地址空间:指虚拟的,人们想象出来的地址空间,其实它并不存在,每一个进程都有自己独立的虚拟地址空间,而且每个进程只能访问自己的地址空间,这样就有效的做到了<code>进程的隔离</code></p><h3 id="分段-Segmentation"><a href="#分段-Segmentation" class="headerlink" title="分段(Segmentation)"></a>分段(Segmentation)</h3><blockquote><p>基本思路: 把一段与程序所需要的内存空间大小的虚拟空间映射到某个地址空间</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">                                           +-------------------+</span><br><span class="line">                                           |                   |</span><br><span class="line">                                           |                   |</span><br><span class="line">0x0640 0000+----------------XX             |                   |</span><br><span class="line">           |                | XXXX         |                   |</span><br><span class="line">           |                |    XXXXXXXXXXX-------------------+0x7000 0000</span><br><span class="line">           |                |              |                   |         +</span><br><span class="line">           |                |              |                   |         |</span><br><span class="line">           |                |              |                   |         |</span><br><span class="line">           |  Virtual Addr  |              |                   |         |</span><br><span class="line">           |  Space of B    |              |      Physical     |         |</span><br><span class="line">           |                |              |  Address Space    |         |</span><br><span class="line">           |                |    map       |      of B         |         |</span><br><span class="line">           |                |              |                   |         v</span><br><span class="line">           |                |              |                   |       100MB</span><br><span class="line">           |                |              |                   |         ^</span><br><span class="line">           |                |              |                   |         |</span><br><span class="line">           |                |              |                   |         |</span><br><span class="line">           |                |              |                   |         |</span><br><span class="line">0x0000 0000+----------------XXX            |                   |         |</span><br><span class="line">                               XXXX        |                   |         |</span><br><span class="line">                                  XXXX     |                   |         +</span><br><span class="line">0x00A0 0000+----------------XX       XXXXXX+-------------------+0x00c0 0000</span><br><span class="line">           |  Virtual Addr  |XXX           |                   |</span><br><span class="line">           |  Apace of A    |  XXXXXXXXXXXXX-------------------+0x00B0 0000</span><br><span class="line">           |                |              | Physical Address  |</span><br><span class="line">0x0000 0000+----------------X    map       |    Space of A     |        10MB</span><br><span class="line">                            XXXXX          |                   |</span><br><span class="line">                                 XXXXXXXXXXX-------------------+0x0010 0000</span><br><span class="line">                                           |                   |</span><br><span class="line">                                           |                   |</span><br><span class="line">                                           +-------------------+0x0000 0000</span><br></pre></td></tr></table></figure><p>分段可以解决第一个和第三个问题.</p><ol><li><strong>地址隔离</strong>: 程序A和程序被映射到两块不同的物理空间区域，他们之间没有任何重叠．如果程序Ａ访问访问虚拟空间的地址超过了0x00A0 0000这个范围，那么硬件就会判断这是一个非法访问，拒绝这个地址请求，并将这个请求报告给操作系统或监控程序，由它决定处理．</li><li><strong>固定程序运行地址</strong>：每个程序而言不需要关心虚拟地址与物理地址之间的映射，相当于其透明的，程序编写只需要按照从地址0x0000 0000到0x00A0 0000来编写程序，放置变量，程序不需要重定位．</li></ol><h3 id="分页-Paging"><a href="#分页-Paging" class="headerlink" title="分页(Paging)"></a>分页(Paging)</h3><p>分段是对整个程序而言，其换入换出将增加大量的磁盘访问操作,从而严重影响速度,因此利用<code>程序的局部性原理</code>使用更小粒度的内存分割和映射方法,就是<code>分页(Paging)</code></p><blockquote><p>分页的基本方法是把地址空间人为的等分成固定大小的页,每一页的大小由硬件决定,或硬件支持多种大小的页,由操作系统选择决定页的大小</p></blockquote><p>页大小: MIPS 8K</p><h4 id="Page-Fault"><a href="#Page-Fault" class="headerlink" title="Page Fault"></a>Page Fault</h4><p><img src="/images/2018/12/page_fault_flow.png" alt="page_fault_flow"></p><blockquote><p>进程的虚拟地址空间按<code>页</code>进行分割后,把常用的数据和代码页装载到内存中,把不常用的数据和代码页保存在磁盘中,当需要用到的时候再把它从磁盘中取出来即可.</p></blockquote><p>假设进程<code>Process1</code>,<code>Process2</code>,他们进程中的部分虚拟页面被映射到了物理页面,比如VP0,VP1和VP7映射到PP0,PP2和PP3,但是一部分在磁盘中比如DP0,DP1.</p><ul><li>如果程序运行时,只是有到了VP0,VP1和VP7的页空间,将不存在任何异常,程序正常运行</li><li>如果程序运行是,访问到了VP2和VP3的页空间,由于这两个页不在内存中,在磁盘中DP0和DP1中,因此硬件会捕获到这个信息,这就是<code>段错误(Page Fault)</code></li></ul><h4 id="页映射–数据保护"><a href="#页映射–数据保护" class="headerlink" title="页映射–数据保护"></a>页映射–数据保护</h4><blockquote><p>在页映射时,可以对每个页设置权限属性,谁可以修改,谁可以访问,而只有操作系统有修改页属性的权利</p></blockquote><blockquote><p><strong>Linux内核中如何实现???</strong></p></blockquote><h4 id="MMU-Memory-Management-Unit"><a href="#MMU-Memory-Management-Unit" class="headerlink" title="MMU (Memory Management Unit)"></a>MMU (Memory Management Unit)</h4><blockquote><p>CPU内部集成的一个硬件部件</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+-------------+               +-----------+              +----------------+</span><br><span class="line">|             |    Virtual    |           |   Physical   |    Physical    |</span><br><span class="line">|     CPU     +---------------&gt;    MMU    +--------------&gt;     Memory     |</span><br><span class="line">|             |    Address    |           |   Address    |                |</span><br><span class="line">+-------------+               +-----------+              +----------------+</span><br></pre></td></tr></table></figure><ul><li>所谓CPU的<code>总线地址</code>大多数情况下就是指<code>物理地址</code></li></ul><h2 id="线程-–-Thread"><a href="#线程-–-Thread" class="headerlink" title="线程 – Thread"></a>线程 – Thread</h2><blockquote><p><strong>线程</strong>: <code>执行流的最小单元</code>,有时也称<code>轻量级进程</code>,</p></blockquote><ul><li>一个标准的线程由<code>线程ID</code>,<code>当前指令指针(PC)</code>,<code>寄存器集合</code>和<code>堆栈</code>组成</li><li>通常,一个进程由一个到多个线程组成,各个线程之间共享程序的内存空间(包括代码段,数据段,堆等)及一些进程级资源(如打开文件和信号)</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">+--------------------------------------------------------------+</span><br><span class="line">| +----------------------------------------------------------+ |</span><br><span class="line">| |    代码     |     数据     |    进程空间      |   打开文件   | |</span><br><span class="line">| +------------+--------------+----------------+-------------+ |</span><br><span class="line">|                                                              |</span><br><span class="line">|  +-------------+     +-------------+    +--------------+     |</span><br><span class="line">|  | +---------+ |     | +---------+ |    | +----------+ |     |</span><br><span class="line">|  | |  寄存器  | |     | | 寄存器   | |    | |  寄存器   | |     |</span><br><span class="line">|  | +---------+ |     | +---------+ |    | +----------+ |     |</span><br><span class="line">|  |             |     |             |    |              |     |</span><br><span class="line">|  | +---------+ |     | +---------+ |    | +----------+ |     |</span><br><span class="line">|  | |   栈    | |     | |    栈    | |    | |   栈     | |     |</span><br><span class="line">|  | +---------+ |     | +---------+ |    | +----------+ |     |</span><br><span class="line">|  |             |     |             |    |              |     |</span><br><span class="line">|  |             |     |             |    |              |     |</span><br><span class="line">|  |             |     |             |    |              |     |</span><br><span class="line">|  |             |     |             |    |              |     |</span><br><span class="line">|  |             |     |             |    |              |     |</span><br><span class="line">|  |             |     |             |    |              |     |</span><br><span class="line">|  |             |     |             |    |              |     |</span><br><span class="line">|  |             |     |             |    |              |     |</span><br><span class="line">|  |             |     |             |    |              |     |</span><br><span class="line">|  |             |     |             |    |              |     |</span><br><span class="line">|  | Main Thread |     |   Thread 1  |    |   Thread 2   |     |</span><br><span class="line">|  +-------------+     +-------------+    +--------------+     |</span><br><span class="line">+--------------------------------------------------------------+</span><br></pre></td></tr></table></figure><h3 id="线程的访问权限"><a href="#线程的访问权限" class="headerlink" title="线程的访问权限"></a>线程的访问权限</h3><table><thead><tr><th style="text-align:center">线程私有</th><th style="text-align:left">线程之间共享(进程所有)</th></tr></thead><tbody><tr><td style="text-align:center">局部变量</td><td style="text-align:left">全局变量</td></tr><tr><td style="text-align:center">函数参数</td><td style="text-align:left">堆上的数据</td></tr><tr><td style="text-align:center">TLS数据</td><td style="text-align:left">函数里的静态变量</td></tr><tr><td style="text-align:center">-</td><td style="text-align:left">程序代码,任何线程都有权利读取并执行任何代码</td></tr><tr><td style="text-align:center">-</td><td style="text-align:left">打开的文件, A线程打开的文件可以由线程B读写</td></tr></tbody></table><h3 id="线程调度"><a href="#线程调度" class="headerlink" title="线程调度"></a>线程调度</h3><p>线程的三种状态:</p><ul><li><strong>运行(Runing)</strong>: 此时线程正在执行</li><li><strong>就绪(Ready)</strong>: 此时线程可以立刻运行,但是CPU已经被占用</li><li><strong>等待(Wait)</strong>: 此时线程正在等待某一事件(通常指I/O或同步)发生,无法执行</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">                 无运行线程,且本线程被选中</span><br><span class="line">     +------------------------------------------+</span><br><span class="line">     |                                          |</span><br><span class="line">     |                                          |</span><br><span class="line">     |                                          |</span><br><span class="line">     |                                          |</span><br><span class="line">+----v-----+                              +-----+-----+</span><br><span class="line">|          |         时间片用尽             |           |</span><br><span class="line">|  Runing  +------------------------------&gt;   Ready   |</span><br><span class="line">|          |                              |           |</span><br><span class="line">+----+-----+                              +-----^-----+</span><br><span class="line">     |                                          |</span><br><span class="line">     |                                          |</span><br><span class="line"> 开始等待                                      等待结束</span><br><span class="line">     |                                          |</span><br><span class="line">     |             +----------+                 |</span><br><span class="line">     |             |          |                 |</span><br><span class="line">     +-------------&gt;   Wait   +-----------------+</span><br><span class="line">                   |          |</span><br><span class="line">                   +----------+</span><br></pre></td></tr></table></figure><h3 id="线程安全"><a href="#线程安全" class="headerlink" title="线程安全"></a>线程安全</h3><blockquote><p>多线程并发执行时,数据的一致性</p></blockquote><h4 id="竞争与原子操作"><a href="#竞争与原子操作" class="headerlink" title="竞争与原子操作"></a>竞争与原子操作</h4><ul><li>原子(Atomic):指单指令操作</li></ul><h4 id="锁与同步"><a href="#锁与同步" class="headerlink" title="锁与同步"></a>锁与同步</h4><ol><li><strong>二元信号量</strong>: 最简单的一种锁,它只有两种状态:<code>占用</code>与<code>非占用</code>.适用只能被唯一一个线程独占访问的资源</li><li><strong>互斥量(Mutex)</strong>:与二元信号量类似,资源仅同时允许一个线程访问,但是互斥量是哪个线程获取互斥量,必须哪个线程释放互斥量</li><li><strong>临界区</strong>:互斥量保护的范围,就是临界区</li><li><strong>读写锁</strong>:读写锁两种获取方式<code>共享的(Shared)</code>和<code>独占的(Exclusive)</code>,适用频繁读取,只是偶尔写入的场景</li><li><strong>条件变量</strong>: 类似于一个栅栏,一个条件变量可以被多个线程等待,当时间发生时(条件变量被唤醒),所有线程可以一起恢复执行</li></ol><h3 id="可重入-Reentrant-与线程安全"><a href="#可重入-Reentrant-与线程安全" class="headerlink" title="可重入(Reentrant)与线程安全"></a>可重入(Reentrant)与线程安全</h3><p>一个函数可重入的<strong>特点</strong>:</p><ol><li>不使用任何(局部)静态或全局的非const变量</li><li>不使用任何(局部)静态或全局的非const变量的变量</li><li>仅依赖调用函数提供的参数</li><li>不依赖任何单个资源的锁(mutex等)</li><li>不调用任何不可重入函数</li></ol><h3 id="过度优化"><a href="#过度优化" class="headerlink" title="过度优化"></a>过度优化</h3><p>过度优化带来的问题:</p><ol><li><code>编译器调整顺序</code>:编译器为提高执行速度,将一些结果保存临时寄存器中</li><li><code>CPU动态调度换序</code>: CPU的动态调度,在执行过程中,为了提高效率,几个互补相关的指令,可能被交换执行,或者同时执行</li></ol><p>解决方法:</p><ol><li><code>volatile</code>关键字阻止过度优化<ul><li>阻止编译器为了提高速度将一个变量缓存到寄存器不写回</li><li>阻止编译器调整操作volatile变量的指令顺序</li></ul></li><li><code>barrier</code>指令, 一条barrier指令会阻止CPU将该指令之前的指令交换到barrier指令之后,也就是说CPU执行到barrier指令时,前面的所有指令已经执行完成</li></ol><hr><h1 id="静态链接"><a href="#静态链接" class="headerlink" title="静态链接"></a>静态链接</h1><h2 id="GCC编译过程"><a href="#GCC编译过程" class="headerlink" title="GCC编译过程"></a>GCC编译过程</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$gcc hello.c</span><br></pre></td></tr></table></figure><blockquote><p>编译的过程可以分解成4个步骤:<code>预处理(Prepressing)</code>,<code>编译(Compilation)</code>,<code>汇编(Assembly)</code>和<code>链接(Linking)</code></p></blockquote><p><img src="/images/2018/12/gcc编译过程.png" alt="Gcc编译过程"></p><h3 id="预编译-Prepressing"><a href="#预编译-Prepressing" class="headerlink" title="预编译-Prepressing"></a>预编译-Prepressing</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gcc -E hello.c -o hello.i</span><br><span class="line">或</span><br><span class="line">cpp hello.c &gt; hello.i</span><br></pre></td></tr></table></figure><p>预编译过程主要处理源代码中以<code>&quot;#&quot;</code>开始的预编译指令.比如”#include”, “#define”</p><p>处理规则:</p><ul><li>将所有的<code>&quot;#define&quot;</code>删除,并且展开所有的宏定义</li><li>处理所有条件预编译指令,比如<code>&quot;#if&quot;</code>, <code>&quot;ifdef&quot;</code>, <code>&quot;#elif&quot;</code>, <code>&quot;#else&quot;</code>, <code>&quot;#endif&quot;</code></li><li>处理<code>&quot;#include&quot;</code>预编译指令,将包含的文件插入到该预编译指令的位置,注意这个过程是递归进行的,也就是说被包含的文件可能还包含其他文件</li><li>删除所有注释<code>&quot;//&quot;</code>和<code>&quot;/* */&quot;</code></li><li>添加行号和文件标识,比如#2 “hello.c” 2,以便于编译时编译器产生调试用的行号信息及用于编译时产生编译错误和警告时能够显示行号</li><li>保留所有的<code>&quot;#pragma&quot;</code>编译器指令,因为编译器需要使用它们</li></ul><h3 id="编译-Compilation"><a href="#编译-Compilation" class="headerlink" title="编译-Compilation"></a>编译-Compilation</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -S hello.i -o hello.s</span><br></pre></td></tr></table></figure><p>编译的过程就是把预处理完的文件进行一系列词法分析,语法分析,语义分析及优化后生成相应的汇编代码文件</p><h3 id="汇编-Assembly"><a href="#汇编-Assembly" class="headerlink" title="汇编-Assembly"></a>汇编-Assembly</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gcc -c hello.s -o hello.o</span><br><span class="line">或</span><br><span class="line">as hello.s -o hello.o</span><br></pre></td></tr></table></figure><h3 id="链接-Linking"><a href="#链接-Linking" class="headerlink" title="链接-Linking"></a>链接-Linking</h3><p>通过<code>ld</code>链接一些必要的文件使其生成一个可执行文件</p><h3 id="示例-Gcc-7-3-0"><a href="#示例-Gcc-7-3-0" class="headerlink" title="示例: Gcc 7.3.0"></a>示例: Gcc 7.3.0</h3><p>环境编译器及系统: <code>gcc version 7.3.0 (Ubuntu 7.3.0-27ubuntu1~18.04)</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc hello.c -v</span><br></pre></td></tr></table></figure><ul><li><code>-v</code>: 显示编译器调用处理的细节</li><li><code>-save-temps</code>: 不删除中间临时文件,如*.i, *.s</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">=====&gt;$gcc hello.c -v  -save-temps</span><br><span class="line">Using built-in specs.</span><br><span class="line">COLLECT_GCC=gcc</span><br><span class="line">COLLECT_LTO_WRAPPER=/usr/lib/gcc/x86_64-linux-gnu/7/lto-wrapper</span><br><span class="line">OFFLOAD_TARGET_NAMES=nvptx-none</span><br><span class="line">OFFLOAD_TARGET_DEFAULT=1</span><br><span class="line">Target: x86_64-linux-gnu</span><br><span class="line">Configured with: ../src/configure -v --with-pkgversion=&apos;Ubuntu 7.3.0-27ubuntu1~18.04&apos; --with-bugurl=file:///usr/share/doc/gcc-7/README.Bugs --enable-languages=c,ada,c++,go,brig,d,fortran,objc,obj-c++ --prefix=/usr --with-gcc-major-version-only --program-suffix=-7 --program-prefix=x86_64-linux-gnu- --enable-shared --enable-linker-build-id --libexecdir=/usr/lib --without-included-gettext --enable-threads=posix --libdir=/usr/lib --enable-nls --with-sysroot=/ --enable-clocale=gnu --enable-libstdcxx-debug --enable-libstdcxx-time=yes --with-default-libstdcxx-abi=new --enable-gnu-unique-object --disable-vtable-verify --enable-libmpx --enable-plugin --enable-default-pie --with-system-zlib --with-target-system-zlib --enable-objc-gc=auto --enable-multiarch --disable-werror --with-arch-32=i686 --with-abi=m64 --with-multilib-list=m32,m64,mx32 --enable-multilib --with-tune=generic --enable-offload-targets=nvptx-none --without-cuda-driver --enable-checking=release --build=x86_64-linux-gnu --host=x86_64-linux-gnu --target=x86_64-linux-gnu</span><br><span class="line">Thread model: posix</span><br><span class="line">gcc version 7.3.0 (Ubuntu 7.3.0-27ubuntu1~18.04)</span><br><span class="line">COLLECT_GCC_OPTIONS=&apos;-v&apos; &apos;-save-temps&apos; &apos;-mtune=generic&apos; &apos;-march=x86-64&apos;</span><br><span class="line"> /usr/lib/gcc/x86_64-linux-gnu/7/cc1 -E -quiet -v -imultiarch x86_64-linux-gnu hello.c -mtune=generic -march=x86-64 -fpch-preprocess -fstack-protector-strong -Wformat -Wformat-security -o hello.i</span><br><span class="line">ignoring nonexistent directory &quot;/usr/local/include/x86_64-linux-gnu&quot;</span><br><span class="line">ignoring nonexistent directory &quot;/usr/lib/gcc/x86_64-linux-gnu/7/../../../../x86_64-linux-gnu/include&quot;</span><br><span class="line">#include &quot;...&quot; search starts here:</span><br><span class="line">#include &lt;...&gt; search starts here:</span><br><span class="line"> /usr/lib/gcc/x86_64-linux-gnu/7/include</span><br><span class="line"> /usr/local/include</span><br><span class="line"> /usr/lib/gcc/x86_64-linux-gnu/7/include-fixed</span><br><span class="line"> /usr/include/x86_64-linux-gnu</span><br><span class="line"> /usr/include</span><br><span class="line">End of search list.</span><br><span class="line">COLLECT_GCC_OPTIONS=&apos;-v&apos; &apos;-save-temps&apos; &apos;-mtune=generic&apos; &apos;-march=x86-64&apos;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> /usr/lib/gcc/x86_64-linux-gnu/7/cc1 -fpreprocessed hello.i -quiet -dumpbase hello.c -mtune=generic -march=x86-64 -auxbase hello -version -fstack-protector-strong -Wformat -Wformat-security -o hello.s</span><br><span class="line">GNU C11 (Ubuntu 7.3.0-27ubuntu1~18.04) version 7.3.0 (x86_64-linux-gnu)</span><br><span class="line">	compiled by GNU C version 7.3.0, GMP version 6.1.2, MPFR version 4.0.1, MPC version 1.1.0, isl version isl-0.19-GMP</span><br><span class="line"></span><br><span class="line">GGC heuristics: --param ggc-min-expand=100 --param ggc-min-heapsize=131072</span><br><span class="line">GNU C11 (Ubuntu 7.3.0-27ubuntu1~18.04) version 7.3.0 (x86_64-linux-gnu)</span><br><span class="line">	compiled by GNU C version 7.3.0, GMP version 6.1.2, MPFR version 4.0.1, MPC version 1.1.0, isl version isl-0.19-GMP</span><br><span class="line"></span><br><span class="line">GGC heuristics: --param ggc-min-expand=100 --param ggc-min-heapsize=131072</span><br><span class="line">Compiler executable checksum: c8081a99abb72bbfd9129549110a350c</span><br><span class="line">COLLECT_GCC_OPTIONS=&apos;-v&apos; &apos;-save-temps&apos; &apos;-mtune=generic&apos; &apos;-march=x86-64&apos;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> as -v --64 -o hello.o hello.s</span><br><span class="line">GNU assembler version 2.30 (x86_64-linux-gnu) using BFD version (GNU Binutils for Ubuntu) 2.30</span><br><span class="line">COMPILER_PATH=/usr/lib/gcc/x86_64-linux-gnu/7/:/usr/lib/gcc/x86_64-linux-gnu/7/:/usr/lib/gcc/x86_64-linux-gnu/:/usr/lib/gcc/x86_64-linux-gnu/7/:/usr/lib/gcc/x86_64-linux-gnu/</span><br><span class="line">LIBRARY_PATH=/usr/lib/gcc/x86_64-linux-gnu/7/:/usr/lib/gcc/x86_64-linux-gnu/7/../../../x86_64-linux-gnu/:/usr/lib/gcc/x86_64-linux-gnu/7/../../../../lib/:/lib/x86_64-linux-gnu/:/lib/../lib/:/usr/lib/x86_64-linux-gnu/:/usr/lib/../lib/:/usr/lib/gcc/x86_64-linux-gnu/7/../../../:/lib/:/usr/lib/</span><br><span class="line">COLLECT_GCC_OPTIONS=&apos;-v&apos; &apos;-save-temps&apos; &apos;-mtune=generic&apos; &apos;-march=x86-64&apos;</span><br><span class="line"></span><br><span class="line"> /usr/lib/gcc/x86_64-linux-gnu/7/collect2 -plugin /usr/lib/gcc/x86_64-linux-gnu/7/liblto_plugin.so -plugin-opt=/usr/lib/gcc/x86_64-linux-gnu/7/lto-wrapper -plugin-opt=-fresolution=hello.res -plugin-opt=-pass-through=-lgcc -plugin-opt=-pass-through=-lgcc_s -plugin-opt=-pass-through=-lc -plugin-opt=-pass-through=-lgcc -plugin-opt=-pass-through=-lgcc_s --sysroot=/ --build-id --eh-frame-hdr -m elf_x86_64 --hash-style=gnu --as-needed -dynamic-linker /lib64/ld-linux-x86-64.so.2 -pie -z now -z relro /usr/lib/gcc/x86_64-linux-gnu/7/../../../x86_64-linux-gnu/Scrt1.o /usr/lib/gcc/x86_64-linux-gnu/7/../../../x86_64-linux-gnu/crti.o /usr/lib/gcc/x86_64-linux-gnu/7/crtbeginS.o -L/usr/lib/gcc/x86_64-linux-gnu/7 -L/usr/lib/gcc/x86_64-linux-gnu/7/../../../x86_64-linux-gnu -L/usr/lib/gcc/x86_64-linux-gnu/7/../../../../lib -L/lib/x86_64-linux-gnu -L/lib/../lib -L/usr/lib/x86_64-linux-gnu -L/usr/lib/../lib -L/usr/lib/gcc/x86_64-linux-gnu/7/../../.. hello.o -lgcc --push-state --as-needed -lgcc_s --pop-state -lc -lgcc --push-state --as-needed -lgcc_s --pop-state /usr/lib/gcc/x86_64-linux-gnu/7/crtendS.o /usr/lib/gcc/x86_64-linux-gnu/7/../../../x86_64-linux-gnu/crtn.o</span><br><span class="line">COLLECT_GCC_OPTIONS=&apos;-v&apos; &apos;-save-temps&apos; &apos;-mtune=generic&apos; &apos;-march=x86-64&apos;</span><br></pre></td></tr></table></figure><p><strong>注意</strong>:在链接时使用的是<code>collect2</code>,不是<code>ld</code>,那么二者有什么关系??</p><blockquote><p><code>collect2</code>是<code>ld</code>链接器的一个<code>封装</code>,最终还是要调用ld来完成链接工作,collect2的作用是在实现main函数的代码前对目标文件中命名的特殊符号进行收集. 这些特殊的符号表明它们是全局构造函数或在main前执行，collect2会生成一个临时的.c文件，将这些符号的地址收集成一个数组，然后放到这个.c文件里面，编译后与其他目标文件一起被链接到最终的输出文件中。在这里我们没有加-nostdlib,所以自然不会调用__main,也就不会链接main函数所需引用的目标文件,也就不会对那些特殊的符号进行收集.</p></blockquote><h2 id="目标文件–Object-File"><a href="#目标文件–Object-File" class="headerlink" title="目标文件–Object File"></a>目标文件–Object File</h2><p>目标文件及可执行文件,主要格式Windows下<code>PE(Portable Executable)</code>和Linux的<code>ELF(Executable Linkable Format)</code>,他们都是<code>COFF(Common file format)</code>的变种</p><blockquote><p>可执行文件按照可执行文件格式存储,<code>动态链接库(DLL, Dynamic Linking Library)</code>及<code>静态链接库(Static Linking Library)</code>文件都是按照可执行文件格式存储</p></blockquote><h3 id="文件格式-ELF"><a href="#文件格式-ELF" class="headerlink" title="文件格式-ELF"></a>文件格式-ELF</h3><ul><li>ELF格式文件分类:</li></ul><table><thead><tr><th style="text-align:center">ELF文件类型</th><th style="text-align:center">说明</th><th style="text-align:center">示例</th></tr></thead><tbody><tr><td style="text-align:center">可重定位文件(Relocatablr File)</td><td style="text-align:center">包含代码和数据,可以被用来链接成可执行文件或共享目标文件,<code>静态链接库属于这类</code></td><td style="text-align:center">Linux的.o, Windows的.obj</td></tr><tr><td style="text-align:center">可执行文件(Executable File)</td><td style="text-align:center">包含可以直接执行的程序,它的代表就是ELF可执行文件,一般没有扩展名</td><td style="text-align:center">比如/bin/bash文件, Windows的.exe</td></tr><tr><td style="text-align:center">共享目标文件(Share Object File)</td><td style="text-align:center">包含代码和数据,可以在两种情况下使用,一种链接器使用生成目标文件,另一种动态链接器可以将几个共享目标文件和可执行文件结合,作为进程映像一起运行</td><td style="text-align:center">Linux的.so, Windows的DLL</td></tr><tr><td style="text-align:center">核心转储文件(Core Dump File)</td><td style="text-align:center">当进程意外终止时,系统可以将该进程的地址空间内容及终止时的一些其他信息转存到核心转储文件</td><td style="text-align:center">Linux下的core dump</td></tr></tbody></table><ul><li>查看</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">=====&gt;$file a.out</span><br><span class="line">a.out: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 3.2.0, BuildID[sha1]=fadad58a4fd9204e015da490f57908c27ba46ccf, not stripped</span><br></pre></td></tr></table></figure><h3 id="ELF的格式"><a href="#ELF的格式" class="headerlink" title="ELF的格式"></a>ELF的格式</h3><p>目标文件的内容包含代码和数据,还有链接时必要的一些信息,比如符号表,调试信息,字符串等.一般目标文件将这些信息按不同的属性,以<code>&quot;节&quot;(Section)</code>的形式存储,有时候也就<code>&quot;段&quot;(Segment)</code>,在一般情况下都表示一个一定长度的区域</p><blockquote><p><code>Section</code>与<code>Segment</code>的区别:???</p><ul><li>在ELF的<code>链接视图</code>(编译)中,不同的属性称为<code>Section</code></li><li>在ELF的<code>装载视图</code>(运行)中,不同的属性称为<code>Segment</code></li></ul></blockquote><p>ELF文件:</p><table><thead><tr><th style="text-align:center">Executable File / Object File</th><th style="text-align:left">说明</th></tr></thead><tbody><tr><td style="text-align:center">File Header</td><td style="text-align:left">包含一个<code>段表(Section Table)</code></td></tr><tr><td style="text-align:center">.text section</td><td style="text-align:left">代码段, 机器指令</td></tr><tr><td style="text-align:center">.data section</td><td style="text-align:left">数据段, 全局变量和局部静态变量数据</td></tr><tr><td style="text-align:center">.bss section</td><td style="text-align:left">未初始化的全局变量和局部静态变量,默认值为<code>0</code></td></tr></tbody></table><p><strong>注</strong>:</p><ul><li><code>段表</code>,是一个描述文件中各个段的数组,描述了文件中各个段在文件中的偏移位置及段的属性等</li><li><code>.bss</code>, 只是为未初始化的全局变量和局部静态变量预留位置而已,它并没有内容,所以它在文件中也不占空间</li></ul><p><strong>总体来说,程序源代码被编译后主要分成两种段, <code>程序指令</code>和<code>程序数据</code>,代码段属于程序指令,而数据段和.bss段 属于程序数据</strong></p><h3 id="数据和指令分段的好处"><a href="#数据和指令分段的好处" class="headerlink" title="数据和指令分段的好处"></a>数据和指令分段的好处</h3><ol><li><code>权限控制</code>, 当程序被装载后,数据和指令分别被映射到两个虚存区域.由于数据局域对进程来说是<code>可读写</code>的,指令区域对进程来说是<code>只读</code>的,所以这两个虚存区域的权限可以被分别设置成可读写和只读.这样可以<strong>防止程序被有意或无意的修改.</strong></li><li>CPU的设计角度出发,现代CPU都有着缓存(Cache)体系.指令区和数据区的分离有利于提高程序的局部性.现代CPU的缓存一般都设计成<strong>数据缓存(D-Cache)和指令缓存(I-Cache)分离,所以程序的指令和数据分开存放对CPU的缓存命中率提高有好处.</strong></li><li><code>指令共享</code>, 当系统中运行多个该程序的副本时,它们的指令都是一样的,所以内存中只需要保存一份程序的指令部分.</li></ol><h2 id="挖掘SimpleSection-o"><a href="#挖掘SimpleSection-o" class="headerlink" title="挖掘SimpleSection.o"></a>挖掘SimpleSection.o</h2><p>示例分析ELF格式的文件</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*#############################################################</span></span><br><span class="line"><span class="comment"> *     File Name	: SimpleSection.c</span></span><br><span class="line"><span class="comment"> *     Author		: winddoing</span></span><br><span class="line"><span class="comment"> *     Created Time	: 2018年12月18日 星期二 15时17分55秒</span></span><br><span class="line"><span class="comment"> *     Description	:</span></span><br><span class="line"><span class="comment"> *          gcc -c SimpleSection.c -o SimpleSection.o</span></span><br><span class="line"><span class="comment"> *          gcc version 7.3.0 (Ubuntu 7.3.0-27ubuntu1~18.04)</span></span><br><span class="line"><span class="comment"> *############################################################*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">printf</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* format, ...)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> global_init_var = <span class="number">84</span>;</span><br><span class="line"><span class="keyword">int</span> global_uninit_var;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">func1</span><span class="params">(<span class="keyword">int</span> i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, i);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> static_var = <span class="number">85</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> static_var2;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> a = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> b;</span><br><span class="line"></span><br><span class="line">    func1(static_var + static_var2 + a + b);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>系统环境: ubuntu18.04 64bit, gcc version 7.3.0</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -c SimpleSection.c -o SimpleSection.o</span><br></pre></td></tr></table></figure><blockquote><p><code>-c</code>: 表示只编译不链接</p></blockquote><p>Object文件的内部结构:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$objdump -h SimpleSection.o</span><br></pre></td></tr></table></figure><blockquote><ul><li><code>-h</code>: 打印ELF文件各个段的基本信息</li><li><code>-x</code>: 全部详细打印输出</li></ul></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">SimpleSection.o:     file format elf64-x86<span class="number">-64</span></span><br><span class="line"></span><br><span class="line">Sections:</span><br><span class="line">Idx Name          Size      VMA               LMA               File off  Algn</span><br><span class="line">  <span class="number">0</span> .text         <span class="number">0000005</span>e  <span class="number">0000000000000000</span>  <span class="number">0000000000000000</span>  <span class="number">00000040</span>  <span class="number">2</span>**<span class="number">0</span></span><br><span class="line">                  CONTENTS, ALLOC, LOAD, RELOC, READONLY, CODE</span><br><span class="line">  <span class="number">1</span> .data         <span class="number">00000008</span>  <span class="number">0000000000000000</span>  <span class="number">0000000000000000</span>  <span class="number">000000</span>a0  <span class="number">2</span>**<span class="number">2</span></span><br><span class="line">                  CONTENTS, ALLOC, LOAD, DATA</span><br><span class="line">  <span class="number">2</span> .bss          <span class="number">00000004</span>  <span class="number">0000000000000000</span>  <span class="number">0000000000000000</span>  <span class="number">000000</span>a8  <span class="number">2</span>**<span class="number">2</span></span><br><span class="line">                  ALLOC</span><br><span class="line">  <span class="number">3</span> .rodata       <span class="number">00000004</span>  <span class="number">0000000000000000</span>  <span class="number">0000000000000000</span>  <span class="number">000000</span>a8  <span class="number">2</span>**<span class="number">0</span></span><br><span class="line">                  CONTENTS, ALLOC, LOAD, READONLY, DATA</span><br><span class="line">  <span class="number">4</span> .comment      <span class="number">0000002b</span>  <span class="number">0000000000000000</span>  <span class="number">0000000000000000</span>  <span class="number">000000</span>ac  <span class="number">2</span>**<span class="number">0</span></span><br><span class="line">                  CONTENTS, READONLY</span><br><span class="line">  <span class="number">5</span> .note.GNU-<span class="built_in">stack</span> <span class="number">00000000</span>  <span class="number">0000000000000000</span>  <span class="number">0000000000000000</span>  <span class="number">000000</span>d7  <span class="number">2</span>**<span class="number">0</span></span><br><span class="line">                  CONTENTS, READONLY</span><br><span class="line">  <span class="number">6</span> .eh_frame     <span class="number">00000058</span>  <span class="number">0000000000000000</span>  <span class="number">0000000000000000</span>  <span class="number">000000</span>d8  <span class="number">2</span>**<span class="number">3</span></span><br><span class="line">                  CONTENTS, ALLOC, LOAD, RELOC, READONLY, DATA</span><br></pre></td></tr></table></figure><table><thead><tr><th style="text-align:center">Section Name</th><th style="text-align:center">注释</th></tr></thead><tbody><tr><td style="text-align:center">.text</td><td style="text-align:center">代码段</td></tr><tr><td style="text-align:center">.data</td><td style="text-align:center">数据段</td></tr><tr><td style="text-align:center">.bss</td><td style="text-align:center">BSS段</td></tr><tr><td style="text-align:center">.rodata</td><td style="text-align:center">只读数据段</td></tr><tr><td style="text-align:center">.comment</td><td style="text-align:center">注释信息段</td></tr><tr><td style="text-align:center">.note.GNU-stack</td><td style="text-align:center">堆栈提示段</td></tr><tr><td style="text-align:center">.eh_frame</td><td style="text-align:center">展开堆栈所需的调用帧信息</td></tr></tbody></table><blockquote><p>eh_frame, <a href="http://blog.51cto.com/zorro/1034925" target="_blank" rel="noopener">http://blog.51cto.com/zorro/1034925</a></p></blockquote><h3 id="ELF的结构"><a href="#ELF的结构" class="headerlink" title="ELF的结构"></a>ELF的结构</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">+----------------------+</span><br><span class="line">|                      |</span><br><span class="line">|                      |</span><br><span class="line">|                      |</span><br><span class="line">|      Other Data      |</span><br><span class="line">|                      |</span><br><span class="line">|                      |</span><br><span class="line">|                      |</span><br><span class="line">|                      |</span><br><span class="line">+----------------------+ 0x0000 00d8</span><br><span class="line">|       .eh_frame      |</span><br><span class="line">+----------------------+ 0x0000 00d7</span><br><span class="line">|                      |</span><br><span class="line">|       .comment       |</span><br><span class="line">|                      |</span><br><span class="line">+----------------------+ 0x0000 00ac</span><br><span class="line">|       .rodata        |</span><br><span class="line">|                      |</span><br><span class="line">+----------------------+ 0x0000 00a8</span><br><span class="line">|        .data         |</span><br><span class="line">+----------------------+ 0x0000 00a0</span><br><span class="line">|                      |</span><br><span class="line">|                      |</span><br><span class="line">|        .text         |</span><br><span class="line">|                      |</span><br><span class="line">|                      |</span><br><span class="line">+----------------------+ 0x0000 0040</span><br><span class="line">|                      |</span><br><span class="line">|     ELF Header       |</span><br><span class="line">|                      |</span><br><span class="line">+----------------------+ 0x0000 0000</span><br></pre></td></tr></table></figure><p>查看ELF文件中代码段,数据段,和BSS段的长度,<code>size</code>命令</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$size SimpleSection.o</span><br><span class="line">   text	   data	    bss	    dec	    hex	filename</span><br><span class="line">    186	      8	      4	    198	     c6	SimpleSection.o</span><br></pre></td></tr></table></figure><h3 id="代码段"><a href="#代码段" class="headerlink" title="代码段"></a>代码段</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$objdump -s -d SimpleSection.o</span><br></pre></td></tr></table></figure><blockquote><ul><li><code>-s</code>: 将所有段的内容以十六进制的方式打印出来</li><li><code>-d</code>: 将所有包含指令的段反汇编</li></ul></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">SimpleSection.o:     file format elf64-x86<span class="number">-64</span></span><br><span class="line"></span><br><span class="line">Contents of section .text:</span><br><span class="line"> <span class="number">0000</span> <span class="number">554889e5</span> <span class="number">4883</span>ec10 <span class="number">897</span>dfc8b <span class="number">45f</span>c89c6  UH..H....&#125;..E...</span><br><span class="line"> <span class="number">0010</span> <span class="number">488</span>d3d00 <span class="number">000000b</span>8 <span class="number">00000000</span> e8000000  H.=.............</span><br><span class="line"> <span class="number">0020</span> <span class="number">0090</span>c9c3 <span class="number">554889e5</span> <span class="number">4883</span>ec20 <span class="number">897</span>dec48  ....UH..H.. .&#125;.H</span><br><span class="line"> <span class="number">0030</span> <span class="number">8975e0</span>c7 <span class="number">45f</span>80100 <span class="number">00008b</span>15 <span class="number">00000000</span>  .u..E...........</span><br><span class="line"> <span class="number">0040</span> <span class="number">8b</span>050000 <span class="number">000001</span>c2 <span class="number">8b</span>45f801 c28b45fc  .........E....E.</span><br><span class="line"> <span class="number">0050</span> <span class="number">01</span>d089c7 e8000000 <span class="number">008b</span>45f8 c9c3      ..........E...</span><br><span class="line">Contents of section .data:</span><br><span class="line"> <span class="number">0000</span> <span class="number">54000000</span> <span class="number">55000000</span>                    T...U...</span><br><span class="line">Contents of section .rodata:</span><br><span class="line"> <span class="number">0000</span> <span class="number">25640</span>a00                             %d..</span><br><span class="line">Contents of section .comment:</span><br><span class="line"> <span class="number">0000</span> <span class="number">00474343</span> <span class="number">3</span>a202855 <span class="number">62756e74</span> <span class="number">7520372</span>e  .GCC: (Ubuntu <span class="number">7.</span></span><br><span class="line"> <span class="number">0010</span> <span class="number">332e302</span>d <span class="number">32377562</span> <span class="number">756e7475</span> <span class="number">317e3138</span>  <span class="number">3.0</span><span class="number">-27u</span>buntu1~<span class="number">18</span></span><br><span class="line"> <span class="number">0020</span> <span class="number">2e303429</span> <span class="number">20372e33</span> <span class="number">2e3000</span>             <span class="number">.04</span>) <span class="number">7.3</span><span class="number">.0</span>.</span><br><span class="line">Contents of section .eh_frame:</span><br><span class="line"> <span class="number">0000</span> <span class="number">14000000</span> <span class="number">00000000</span> <span class="number">017</span>a5200 <span class="number">01781001</span>  .........zR..x..</span><br><span class="line"> <span class="number">0010</span> <span class="number">1b</span>0c0708 <span class="number">90010000</span> <span class="number">1</span>c000000 <span class="number">1</span>c000000  ................</span><br><span class="line"> <span class="number">0020</span> <span class="number">00000000</span> <span class="number">24000000</span> <span class="number">00410e10</span> <span class="number">8602430</span>d  ....$....A....C.</span><br><span class="line"> <span class="number">0030</span> <span class="number">065f</span>0c07 <span class="number">08000000</span> <span class="number">1</span>c000000 <span class="number">3</span>c000000  ._..........&lt;...</span><br><span class="line"> <span class="number">0040</span> <span class="number">00000000</span> <span class="number">3</span>a000000 <span class="number">00410e10</span> <span class="number">8602430</span>d  ....:....A....C.</span><br><span class="line"> <span class="number">0050</span> <span class="number">06750</span>c07 <span class="number">08000000</span>                    .u......</span><br><span class="line"></span><br><span class="line">Disassembly of section .text:</span><br><span class="line"></span><br><span class="line"><span class="number">0000000000000000</span> &lt;func1&gt;:</span><br><span class="line">   <span class="number">0</span>:	<span class="number">55</span>                   	push   %rbp</span><br><span class="line">   <span class="number">1</span>:	<span class="number">48</span> <span class="number">89</span> e5             	mov    %rsp,%rbp</span><br><span class="line">   <span class="number">4</span>:	<span class="number">48</span> <span class="number">83</span> ec <span class="number">10</span>          	sub    $<span class="number">0x10</span>,%rsp</span><br><span class="line">   <span class="number">8</span>:	<span class="number">89</span> <span class="number">7</span>d fc             	mov    %edi,<span class="number">-0x4</span>(%rbp)</span><br><span class="line">   b:	<span class="number">8b</span> <span class="number">45</span> fc             	mov    <span class="number">-0x4</span>(%rbp),%eax</span><br><span class="line">   e:	<span class="number">89</span> c6                	mov    %eax,%esi</span><br><span class="line">  <span class="number">10</span>:	<span class="number">48</span> <span class="number">8</span>d <span class="number">3</span>d <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> 	lea    <span class="number">0x0</span>(%rip),%rdi        # <span class="number">17</span> &lt;func1+<span class="number">0x17</span>&gt;</span><br><span class="line">  <span class="number">17</span>:	b8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	mov    $<span class="number">0x0</span>,%eax</span><br><span class="line">  <span class="number">1</span>c:	e8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	callq  <span class="number">21</span> &lt;func1+<span class="number">0x21</span>&gt;</span><br><span class="line">  <span class="number">21</span>:	<span class="number">90</span>                   	nop</span><br><span class="line">  <span class="number">22</span>:	c9                   	leaveq</span><br><span class="line">  <span class="number">23</span>:	c3                   	retq</span><br><span class="line"></span><br><span class="line"><span class="number">0000000000000024</span> &lt;main&gt;:</span><br><span class="line">  <span class="number">24</span>:	<span class="number">55</span>                   	push   %rbp</span><br><span class="line">  <span class="number">25</span>:	<span class="number">48</span> <span class="number">89</span> e5             	mov    %rsp,%rbp</span><br><span class="line">  <span class="number">28</span>:	<span class="number">48</span> <span class="number">83</span> ec <span class="number">20</span>          	sub    $<span class="number">0x20</span>,%rsp</span><br><span class="line">  <span class="number">2</span>c:	<span class="number">89</span> <span class="number">7</span>d ec             	mov    %edi,<span class="number">-0x14</span>(%rbp)</span><br><span class="line">  <span class="number">2f</span>:	<span class="number">48</span> <span class="number">89</span> <span class="number">75</span> e0          	mov    %rsi,<span class="number">-0x20</span>(%rbp)</span><br><span class="line">  <span class="number">33</span>:	c7 <span class="number">45</span> f8 <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> 	movl   $<span class="number">0x1</span>,<span class="number">-0x8</span>(%rbp)</span><br><span class="line">  <span class="number">3</span>a:	<span class="number">8b</span> <span class="number">15</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    	mov    <span class="number">0x0</span>(%rip),%edx        # <span class="number">40</span> &lt;main+<span class="number">0x1c</span>&gt;</span><br><span class="line">  <span class="number">40</span>:	<span class="number">8b</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    	mov    <span class="number">0x0</span>(%rip),%eax        # <span class="number">46</span> &lt;main+<span class="number">0x22</span>&gt;</span><br><span class="line">  <span class="number">46</span>:	<span class="number">01</span> c2                	add    %eax,%edx</span><br><span class="line">  <span class="number">48</span>:	<span class="number">8b</span> <span class="number">45</span> f8             	mov    <span class="number">-0x8</span>(%rbp),%eax</span><br><span class="line">  <span class="number">4b</span>:	<span class="number">01</span> c2                	add    %eax,%edx</span><br><span class="line">  <span class="number">4</span>d:	<span class="number">8b</span> <span class="number">45</span> fc             	mov    <span class="number">-0x4</span>(%rbp),%eax</span><br><span class="line">  <span class="number">50</span>:	<span class="number">01</span> d0                	add    %edx,%eax</span><br><span class="line">  <span class="number">52</span>:	<span class="number">89</span> c7                	mov    %eax,%edi</span><br><span class="line">  <span class="number">54</span>:	e8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	callq  <span class="number">59</span> &lt;main+<span class="number">0x35</span>&gt;</span><br><span class="line">  <span class="number">59</span>:	<span class="number">8b</span> <span class="number">45</span> f8             	mov    <span class="number">-0x8</span>(%rbp),%eax</span><br><span class="line">  <span class="number">5</span>c:	c9                   	leaveq</span><br><span class="line">  <span class="number">5</span>d:	c3                   	retq</span><br></pre></td></tr></table></figure><h3 id="数据段和只读数据段"><a href="#数据段和只读数据段" class="headerlink" title="数据段和只读数据段"></a>数据段和只读数据段</h3><ul><li><p>数据段: <code>.data</code>主要存放<code>初始化</code>了的<strong>全局静态变量</strong>和<strong>局部静态变量</strong></p><blockquote><p>在SimpleSection.c示例中, 有这样两个变量<code>global_init_var</code>和<code>static_var</code>, 一共8字节,所以<code>.data</code>段的大小将是8字节</p></blockquote></li><li><p>只读数据段: <code>.rodata</code>存放的只读数据.一般是程序中的<strong>只读变量</strong>(const修饰的变量)和<strong>字符串常量</strong></p><blockquote><p><strong>好处:</strong></p><ul><li>操作系统在加载时,将<code>.rodata</code>段映射成只读后,任何对这个段的操作,将被视为非法操作,保证了程序的安全性</li><li>在嵌入式平台中,有些存储器是采用的只读存储器,如ROM,这样将<code>rodata</code>段放在该存储区域就可以保证程序访问存储器的正确性(比如固化在CPU中的bootram的数据段映射)</li></ul></blockquote></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">objdump -s SimpleSection.o</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Contents of section .data:</span><br><span class="line"> <span class="number">0000</span> <span class="number">54000000</span> <span class="number">55000000</span>                    T...U...</span><br><span class="line">Contents of section .rodata:</span><br><span class="line"> <span class="number">0000</span> <span class="number">25640</span>a00                             %d..</span><br></pre></td></tr></table></figure><p><code>global_init_var=84</code>十六进制表示<code>54</code>,占四字节,由于是<strong>小端模式Little Endian</strong>, 排列顺序:[54 00 00 00]</p><h3 id="BBS段"><a href="#BBS段" class="headerlink" title="BBS段"></a>BBS段</h3><ul><li>BBS段: <code>.bss</code>存放<code>未初始化</code>的<strong>全局变量</strong>和<strong>局部静态变量</strong><blockquote><p>在示例中<code>global_uninit_var</code>和<code>static_var2</code>两个变量将存放在BSS段,准确说就是.bss段为其预留空间,但是我们看到该段大小只有4字节,而这两个变量的大小是8字节.</p></blockquote></li></ul><p>不同的语言与不同的编译器实现有关,有些编译器会将<strong>全局的未初始化变量</strong>存放到BSS段,有些则不存放,只是预留一个<strong>未定义的全局变量符号</strong>,等到最终链接成可执行文件时,再在BSS段分配空间.(弱符号和强符号)</p><p><strong>编译单元内部可见的静态变量</strong>(static修饰),的确存放在BSS段</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">objdump -h SimpleSection.o</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Sections:</span><br><span class="line">Idx Name          Size      VMA               LMA               File off  Algn</span><br><span class="line">  <span class="number">2</span> .bss          <span class="number">00000004</span>  <span class="number">0000000000000000</span>  <span class="number">0000000000000000</span>  <span class="number">000000</span>a8  <span class="number">2</span>**<span class="number">2</span></span><br><span class="line">                  ALLOC</span><br></pre></td></tr></table></figure><h3 id="其他段"><a href="#其他段" class="headerlink" title="其他段"></a>其他段</h3><table><thead><tr><th style="text-align:center">常用段名</th><th style="text-align:left">说明</th></tr></thead><tbody><tr><td style="text-align:center"><code>.rodata1</code></td><td style="text-align:left">Read only Data 只存放只读数据,比如字符串常量,全局const变量,和<code>.rodata</code>一样</td></tr><tr><td style="text-align:center"><code>.comment</code></td><td style="text-align:left">存放编译器版本信息,比如字符串:”.GCC: (Ubuntu 7.3.0-27ubuntu1~18.04) 7.3.0.”</td></tr><tr><td style="text-align:center"><code>.debug</code></td><td style="text-align:left">调试信息</td></tr><tr><td style="text-align:center"><code>.dynamic</code></td><td style="text-align:left">动态链接信息</td></tr><tr><td style="text-align:center"><code>.hash</code></td><td style="text-align:left">符号哈希表</td></tr><tr><td style="text-align:center"><code>.line</code></td><td style="text-align:left">调试时的行号表,即源代码行号与编译后指令的对应表</td></tr><tr><td style="text-align:center"><code>.note</code></td><td style="text-align:left">额外的编译器信息,比如程序的公司名,发布版本号</td></tr><tr><td style="text-align:center"><code>.strtab</code></td><td style="text-align:left">String Table字符串表,用于存储ELF文件中用到的各种字符串</td></tr><tr><td style="text-align:center"><code>.symtab</code></td><td style="text-align:left">Symbol Table符号表</td></tr><tr><td style="text-align:center"><code>.shstrtab</code></td><td style="text-align:left">Section String Table 段名表</td></tr><tr><td style="text-align:center"><code>.plt</code> <code>.got</code></td><td style="text-align:left">动态链接的跳转表和全局入口表</td></tr><tr><td style="text-align:center"><code>.init</code> <code>fini</code></td><td style="text-align:left">程序初始化和终结代码段</td></tr></tbody></table><ul><li>将一个二进制文件,比如图片,音乐作为目标文件中的一个段, 使用<code>objcopy</code>工具</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">objcopy -I binary -O elf64-x86-64  pic.jpg pic.o</span></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">objdump -ht pic.o</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pic.o:     file format elf64-little</span><br><span class="line"></span><br><span class="line">Sections:</span><br><span class="line">Idx Name          Size      VMA               LMA               File off  Algn</span><br><span class="line">  <span class="number">0</span> .data         <span class="number">000799</span>df  <span class="number">0000000000000000</span>  <span class="number">0000000000000000</span>  <span class="number">00000040</span>  <span class="number">2</span>**<span class="number">0</span></span><br><span class="line">                  CONTENTS, ALLOC, LOAD, DATA</span><br><span class="line">SYMBOL TABLE:</span><br><span class="line"><span class="number">0000000000000000</span> l    d  .data	<span class="number">0000000000000000</span> .data</span><br><span class="line"><span class="number">0000000000000000</span> g       .data	<span class="number">0000000000000000</span> _binary_pic_jpg_start</span><br><span class="line"><span class="number">00000000000799</span>df g       .data	<span class="number">0000000000000000</span> _binary_pic_jpg_end</span><br><span class="line"><span class="number">00000000000799</span>df g       *ABS*	<span class="number">0000000000000000</span> _binary_pic_jpg_size</span><br></pre></td></tr></table></figure><p>符号<code>_binary_pic_jpg_start</code>,<code>_binary_pic_jpg_end</code>,<code>_binary_pic_jpg_size</code>表示该图片文件所在内存中的起始地址,结束地址和大小.可以在程序中直接声明并使用它们.</p><h3 id="自定义段"><a href="#自定义段" class="headerlink" title="自定义段"></a>自定义段</h3><p>GCC提供的一种扩展机制,可以指定变量所处的段.</p><blockquote><p>比如为了满足某些硬件的内存或IO地址布局,将某些变量或代码放到指定的段</p></blockquote><p>在全局变量或函数前加<code>&quot;__attribute__((section(&quot;name&quot;)))&quot;</code>属性就可以把相应的变量或函数放到以<code>&quot;name&quot;</code>作为段名的段中<br></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">__attribute__((section(<span class="string">"FOO"</span>))) <span class="keyword">int</span> global = <span class="number">42</span>;</span><br><span class="line">__attribute__((section(<span class="string">"BAR"</span>))) <span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h2 id="ELF文件结构描述"><a href="#ELF文件结构描述" class="headerlink" title="ELF文件结构描述"></a>ELF文件结构描述</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">+----------------------+</span><br><span class="line">|     ELF Header       |</span><br><span class="line">+----------------------+</span><br><span class="line">|        .text         |</span><br><span class="line">+----------------------+</span><br><span class="line">|        .data         |</span><br><span class="line">+----------------------+</span><br><span class="line">|        .bss          |</span><br><span class="line">+----------------------+</span><br><span class="line">|        ...           |</span><br><span class="line">+----------------------+</span><br><span class="line">|    other sections    |</span><br><span class="line">+----------------------+</span><br><span class="line">| Section header table | &lt;== 段表: 描述ELF文件所有段的信息</span><br><span class="line">+----------------------+</span><br><span class="line">|   String Tables      |</span><br><span class="line">|                      |</span><br><span class="line">|   Symbol Tables      |</span><br><span class="line">|                      |</span><br><span class="line">|                      |</span><br><span class="line">+----------------------+</span><br></pre></td></tr></table></figure><blockquote><p>ELF文件分析工具: <code>readelf</code></p></blockquote><h3 id="头文件"><a href="#头文件" class="headerlink" title="头文件"></a>头文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">readelf -h SimpleSection.o</span></span><br></pre></td></tr></table></figure><blockquote><ul><li><code>-h</code>: Display the ELF file header</li></ul></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">头            ELF Header:</span><br><span class="line">ELF魔数          Magic:   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00</span><br><span class="line">文件机器字节长度   Class:                             ELF64</span><br><span class="line">数据存储方式      Data:                              2&apos;s complement, little endian</span><br><span class="line">版本            Version:                           1 (current)</span><br><span class="line">运行平台         OS/ABI:                            UNIX - System V</span><br><span class="line">ABI版本         ABI Version:                       0</span><br><span class="line">ELF重定位类型    Type:                              REL (Relocatable file)</span><br><span class="line">硬件平台         Machine:                           Advanced Micro Devices X86-64</span><br><span class="line">硬件平台版本      Version:                           0x1</span><br><span class="line">入口地址         Entry point address:               0x0</span><br><span class="line">程序入口         Start of program headers:          0 (bytes into file)</span><br><span class="line">段表位置         Start of section headers:          1112 (bytes into file)</span><br><span class="line">                Flags:                             0x0</span><br><span class="line">                Size of this header:               64 (bytes)</span><br><span class="line">                Size of program headers:           0 (bytes)</span><br><span class="line">                Number of program headers:         0</span><br><span class="line">                Size of section headers:           64 (bytes)</span><br><span class="line">                Number of section headers:         13</span><br><span class="line">                Section header string table index: 12</span><br></pre></td></tr></table></figure><ul><li>数据结构定义</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span> e_ident[EI_NIDENT]; <span class="comment">/* Magic number and other info */</span></span><br><span class="line">  Elf64_Half    e_type;         <span class="comment">/* Object file type */</span></span><br><span class="line">  Elf64_Half    e_machine;      <span class="comment">/* Architecture */</span></span><br><span class="line">  Elf64_Word    e_version;      <span class="comment">/* Object file version */</span></span><br><span class="line">  Elf64_Addr    e_entry;        <span class="comment">/* Entry point virtual address */</span></span><br><span class="line">  Elf64_Off e_phoff;        <span class="comment">/* Program header table file offset */</span></span><br><span class="line">  Elf64_Off e_shoff;        <span class="comment">/* Section header table file offset */</span></span><br><span class="line">  Elf64_Word    e_flags;        <span class="comment">/* Processor-specific flags */</span></span><br><span class="line">  Elf64_Half    e_ehsize;       <span class="comment">/* ELF header size in bytes */</span></span><br><span class="line">  Elf64_Half    e_phentsize;        <span class="comment">/* Program header table entry size */</span></span><br><span class="line">  Elf64_Half    e_phnum;        <span class="comment">/* Program header table entry count */</span></span><br><span class="line">  Elf64_Half    e_shentsize;        <span class="comment">/* Section header table entry size */</span></span><br><span class="line">  Elf64_Half    e_shnum;        <span class="comment">/* Section header table entry count */</span></span><br><span class="line">  Elf64_Half    e_shstrndx;     <span class="comment">/* Section header string table index */</span></span><br><span class="line">&#125; Elf64_Ehdr;</span><br></pre></td></tr></table></figure><blockquote><p>file: /usr/include/elf.h</p></blockquote><blockquote><p><strong>ELF魔数</strong>: 最开始的4个字节所有的ELF文件 都必须相同,分别是<code>0x7f</code>,<code>0x45</code>,<code>0x4c</code>, <code>0x46</code></p><ul><li>第一个字节对应ASCII字符: DEL字符</li><li>后面3个字符对应ASCII字符: E, L, F</li></ul></blockquote><h3 id="段表"><a href="#段表" class="headerlink" title="段表"></a>段表</h3><p><strong>段表</strong>:保存各个段的基本属性,描述各个段的信息,如段名,段的长度,在文件中的偏移,读写权限等</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">readelf -S SimpleSection.o</span></span><br></pre></td></tr></table></figure><blockquote><ul><li><code>-S</code>: Display the sections’ header,每个段的头信息</li></ul></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">There are 13 section headers, starting at offset 0x458:</span><br><span class="line"></span><br><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type             Address           Offset</span><br><span class="line">       Size              EntSize          Flags  Link  Info  Align</span><br><span class="line">  [ 0]                   NULL             0000000000000000  00000000</span><br><span class="line">       0000000000000000  0000000000000000           0     0     0</span><br><span class="line">  [ 1] .text             PROGBITS         0000000000000000  00000040</span><br><span class="line">       000000000000005e  0000000000000000  AX       0     0     1</span><br><span class="line">  [ 2] .rela.text        RELA             0000000000000000  00000348</span><br><span class="line">       0000000000000078  0000000000000018   I      10     1     8</span><br><span class="line">  [ 3] .data             PROGBITS         0000000000000000  000000a0</span><br><span class="line">       0000000000000008  0000000000000000  WA       0     0     4</span><br><span class="line">  [ 4] .bss              NOBITS           0000000000000000  000000a8</span><br><span class="line">       0000000000000004  0000000000000000  WA       0     0     4</span><br><span class="line">  [ 5] .rodata           PROGBITS         0000000000000000  000000a8</span><br><span class="line">       0000000000000004  0000000000000000   A       0     0     1</span><br><span class="line">  [ 6] .comment          PROGBITS         0000000000000000  000000ac</span><br><span class="line">       000000000000002b  0000000000000001  MS       0     0     1</span><br><span class="line">  [ 7] .note.GNU-stack   PROGBITS         0000000000000000  000000d7</span><br><span class="line">       0000000000000000  0000000000000000           0     0     1</span><br><span class="line">  [ 8] .eh_frame         PROGBITS         0000000000000000  000000d8</span><br><span class="line">       0000000000000058  0000000000000000   A       0     0     8</span><br><span class="line">  [ 9] .rela.eh_frame    RELA             0000000000000000  000003c0</span><br><span class="line">       0000000000000030  0000000000000018   I      10     8     8</span><br><span class="line">  [10] .symtab           SYMTAB           0000000000000000  00000130</span><br><span class="line">       0000000000000198  0000000000000018          11    11     8</span><br><span class="line">  [11] .strtab           STRTAB           0000000000000000  000002c8</span><br><span class="line">       000000000000007c  0000000000000000           0     0     1</span><br><span class="line">  [12] .shstrtab         STRTAB           0000000000000000  000003f0</span><br><span class="line">       0000000000000061  0000000000000000           0     0     1</span><br><span class="line">Key to Flags:</span><br><span class="line">  W (write), A (alloc), X (execute), M (merge), S (strings), I (info),</span><br><span class="line">  L (link order), O (extra OS processing required), G (group), T (TLS),</span><br><span class="line">  C (compressed), x (unknown), o (OS specific), E (exclude),</span><br><span class="line">  l (large), p (processor specific)</span><br></pre></td></tr></table></figure><ul><li>各段在文件的分布:<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">start +------------------+0x0000 0000</span><br><span class="line">      |   ELF Header     |</span><br><span class="line">      |   e_shoff=0x458 +--------------------+</span><br><span class="line">      +------------------+0x0000 0040        |</span><br><span class="line">      |                  |                   |</span><br><span class="line">      |     .text        |                   |</span><br><span class="line">      |                  |                   |</span><br><span class="line">      +------------------+0x0000 00a0        |</span><br><span class="line">      |     .data        |                   |</span><br><span class="line">      +------------------+0x0000 00a8        |</span><br><span class="line">      |     .rodata      |                   |</span><br><span class="line">      +------------------+0x0000 00ac        |</span><br><span class="line">      |                  |                   |</span><br><span class="line">      |     .comment     |                   |</span><br><span class="line">      +------------------+0x0000 00d7        |</span><br><span class="line">      | .note.GNU|stack  |                   |</span><br><span class="line">      +------------------+0x0000 00d8        |</span><br><span class="line">      |     .eh_frame    |                   |</span><br><span class="line">      |                  |                   |</span><br><span class="line">      |                  |                   |</span><br><span class="line">      |                  |                   |</span><br><span class="line">      +------------------+0x0000 0130        |</span><br><span class="line">      |     .symtab      |                   |</span><br><span class="line">      |                  |                   |</span><br><span class="line">      |                  |                   |</span><br><span class="line">      |                  |                   |</span><br><span class="line">      +------------------+0x0000 02c8        |</span><br><span class="line">      |     .strtab      |                   |</span><br><span class="line">      |                  |                   |</span><br><span class="line">      |                  |                   |</span><br><span class="line">      |                  |                   |</span><br><span class="line">      +------------------+0x0000 0348        |</span><br><span class="line">      |    .rela.text    |                   |</span><br><span class="line">      |                  |                   |</span><br><span class="line">      |                  |                   |</span><br><span class="line">      +------------------+0x0000 03c0        |</span><br><span class="line">      |  .rela.eh_frame  |                   |</span><br><span class="line">      |                  |                   |</span><br><span class="line">      |                  |                   |</span><br><span class="line">      +------------------+0x0000 03f0        |</span><br><span class="line">      |     .shstrtab    |                   |</span><br><span class="line">      |                  |                   |</span><br><span class="line">      |               &lt;--+0x0000 0451        |</span><br><span class="line">      |                  |                   |</span><br><span class="line">      +------------------+0x0000 0458 &lt;------+</span><br><span class="line">      |                  |</span><br><span class="line">      |   Section Table  |</span><br><span class="line">      |                  |</span><br><span class="line">      |                  |</span><br><span class="line">      |                  |</span><br><span class="line">      |                  |</span><br><span class="line">      |                  |</span><br><span class="line"> end  +------------------+0x0000 0798</span><br></pre></td></tr></table></figure></li></ul><blockquote><p>文件大小:SimpleSection.o = 1944 = 0x798 Bit</p></blockquote><p><strong>段的名字只是在编译和链接过程中有意义,不能正真代表段的类型</strong></p><ul><li><code>.rela.text</code>: 重定位表(Relocation Table), 链接器处理目标文件时,对目标文件中的某些部位进行重定位,即代码段和数据段中那些绝对地址的引用位置.</li><li><code>.strtab</code>: 字符串表(String Table), 用于保存普通的字符串</li><li><code>.shstrtab</code>: 段表字符串表(Section Header String Table), 用于保存段表中用到的字符串</li></ul><h3 id="字符串表"><a href="#字符串表" class="headerlink" title="字符串表"></a>字符串表</h3><p>ELF文件中对字符串的存储,由于不确定其长度,没有固定的结构进行表示.常用的做法是将字符串集中起来存放在一个表中,使用字符串在表中的偏移来引用字符串</p><ul><li>字符串表:</li></ul><table><thead><tr><th style="text-align:center">偏移</th><th style="text-align:center">+0</th><th style="text-align:center">+1</th><th style="text-align:center">+2</th><th style="text-align:center">+3</th><th style="text-align:center">+4</th><th style="text-align:center">+5</th><th style="text-align:center">+6</th><th style="text-align:center">+7</th><th style="text-align:center">+8</th><th style="text-align:center">+9</th></tr></thead><tbody><tr><td style="text-align:center">+0</td><td style="text-align:center">\0</td><td style="text-align:center">h</td><td style="text-align:center">e</td><td style="text-align:center">l</td><td style="text-align:center">l</td><td style="text-align:center">o</td><td style="text-align:center">w</td><td style="text-align:center">o</td><td style="text-align:center">r</td><td style="text-align:center">l</td></tr><tr><td style="text-align:center">+10</td><td style="text-align:center">d</td><td style="text-align:center">\0</td><td style="text-align:center">M</td><td style="text-align:center">y</td><td style="text-align:center">v</td><td style="text-align:center">a</td><td style="text-align:center">r</td><td style="text-align:center">i</td><td style="text-align:center">a</td><td style="text-align:center">b</td></tr><tr><td style="text-align:center">+20</td><td style="text-align:center">l</td><td style="text-align:center">e</td><td style="text-align:center">\0</td><td style="text-align:center"></td><td style="text-align:center"></td><td style="text-align:center"></td><td style="text-align:center"></td><td style="text-align:center"></td><td style="text-align:center"></td></tr></tbody></table><ul><li>引用</li></ul><table><thead><tr><th style="text-align:center">偏移</th><th style="text-align:left">字符串</th></tr></thead><tbody><tr><td style="text-align:center">0</td><td style="text-align:left">空字符串</td></tr><tr><td style="text-align:center">1</td><td style="text-align:left">helloworld</td></tr><tr><td style="text-align:center">6</td><td style="text-align:left">wrold</td></tr><tr><td style="text-align:center">12</td><td style="text-align:left">Myvariable</td></tr></tbody></table><blockquote><p>字符串表在ELF中以段的形式保存</p></blockquote><table><thead><tr><th style="text-align:center">段</th><th style="text-align:left">段名</th><th style="text-align:left">含义</th></tr></thead><tbody><tr><td style="text-align:center"><code>.strtab</code></td><td style="text-align:left">字符串表(String Table)</td><td style="text-align:left">用于保存普通字符串</td></tr><tr><td style="text-align:center"><code>.shstrtab</code></td><td style="text-align:left">段表字符串表(Section Header String Table)</td><td style="text-align:left">用于保存段表中用到的字符串</td></tr></tbody></table><h2 id="链接的接口–符号"><a href="#链接的接口–符号" class="headerlink" title="链接的接口–符号"></a>链接的接口–符号</h2><blockquote><p>链接的本质就是把多个不同的目标文件(.o)之间相互”粘”到一起</p></blockquote><p>在链接中,将函数和变量统称为<code>符号</code>(Symbol),函数名和变量名统称为<code>符号名</code>(Symbol Name)</p><h3 id="特殊符号"><a href="#特殊符号" class="headerlink" title="特殊符号"></a>特殊符号</h3><table><thead><tr><th style="text-align:center">符号</th><th style="text-align:center">作用</th></tr></thead><tbody><tr><td style="text-align:center">__executable_start</td><td style="text-align:center">程序起始地址(注意不是程序入口地址,是程序最开始执行的地址)</td></tr><tr><td style="text-align:center">__etext_etext\etext</td><td style="text-align:center">代码段结束地址,即代码段最末尾的地址</td></tr><tr><td style="text-align:center">_edata\edata</td><td style="text-align:center">数据段结束地址</td></tr><tr><td style="text-align:center">_end\end</td><td style="text-align:center">程序结束地址</td></tr></tbody></table><blockquote><p>以上地址都是程序装载是的<code>虚拟地址</code></p></blockquote><h3 id="extern-“C”"><a href="#extern-“C”" class="headerlink" title="extern “C”"></a>extern “C”</h3><p>C++为了兼容C,在符号管理上使用<code>extern &quot;C&quot;</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> &#123;</span><br><span class="line">  <span class="function"><span class="keyword">int</span> <span class="title">func</span><span class="params">(<span class="keyword">int</span>)</span></span>;</span><br><span class="line">  <span class="keyword">int</span> var;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="弱符号和强符号"><a href="#弱符号和强符号" class="headerlink" title="弱符号和强符号"></a>弱符号和强符号</h3><table><thead><tr><th style="text-align:center">名称</th><th style="text-align:center">英文</th><th style="text-align:left">示例</th></tr></thead><tbody><tr><td style="text-align:center">弱符号</td><td style="text-align:center">Weak Symbol</td><td style="text-align:left">编译器默认,未初始化的全局变量</td></tr><tr><td style="text-align:center">强符号</td><td style="text-align:center">Strong Symbol</td><td style="text-align:left">编译器默认,函数和初始化的全局变量</td></tr></tbody></table><h4 id="弱符号的定义"><a href="#弱符号的定义" class="headerlink" title="弱符号的定义"></a>弱符号的定义</h4><p>通过GCC的<code>&quot;__attribute__((weak))&quot;</code>定义任何一个强符号为弱符号</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="keyword">int</span> ext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> weak;</span><br><span class="line"><span class="keyword">int</span> strong = <span class="number">1</span>;</span><br><span class="line">__attribute__((weak)) weak2 = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><ul><li><code>weak</code>和<code>waek2</code>是弱符号</li><li><code>strong</code>和<code>main</code>是强符号</li><li><code>ext</code>既非强符号也非弱符号,其是一个外部变量的引用</li></ul></blockquote><h4 id="链接器的处理规则"><a href="#链接器的处理规则" class="headerlink" title="链接器的处理规则"></a>链接器的处理规则</h4><ul><li>规则1: 不允许强符号多次定义.</li><li>规则2: 如果一个符号在某一个目标文件中定义为强符号,在其他目标文件中定义为弱符号,那么选择强符号.</li><li>规则3: 如果一个符号在所有目标文件中都是弱符号,那么选择其中占用空间最大的一个.</li></ul><h3 id="强引用-Strong-Reference-和弱引用-Weak-Reference"><a href="#强引用-Strong-Reference-和弱引用-Weak-Reference" class="headerlink" title="强引用(Strong Reference)和弱引用(Weak Reference)"></a>强引用(Strong Reference)和弱引用(Weak Reference)</h3><p>在GCC中，可以通过<code>__attribute__((weakref))</code>扩展关键字来声明一个外部函数的引用为弱引用</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">__attribute__((weakref)) <span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong><code>弱符合</code>和<code>强符号</code>在库的定义使用中，弱符号可以被用户自定义的强符合所覆盖，从而使得程序可以使用自定义版本函数，方便程序扩展模块的裁剪和组合</strong></p><h2 id="静态链接-1"><a href="#静态链接-1" class="headerlink" title="静态链接"></a>静态链接</h2><hr><h1 id="装载与动态链接"><a href="#装载与动态链接" class="headerlink" title="装载与动态链接"></a>装载与动态链接</h1><hr><h1 id="库与运行库"><a href="#库与运行库" class="headerlink" title="库与运行库"></a>库与运行库</h1><hr><h1 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h1><h2 id="objdump"><a href="#objdump" class="headerlink" title="objdump"></a>objdump</h2><h2 id="objcopy"><a href="#objcopy" class="headerlink" title="objcopy"></a>objcopy</h2><h2 id="readelf"><a href="#readelf" class="headerlink" title="readelf"></a>readelf</h2><h2 id="nm"><a href="#nm" class="headerlink" title="nm"></a>nm</h2><h2 id="strip"><a href="#strip" class="headerlink" title="strip"></a>strip</h2><hr></div></div></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> 文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap"> 站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <a href="/"><img class="site-author-image" itemprop="image" src="/images/Winddoing.jpg" alt="Winddoing"></a><p class="site-author-name" itemprop="name">Winddoing</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">175</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/index.html"><span class="site-state-item-count">42</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/index.html"><span class="site-state-item-count">147</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/Winddoing" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="https://coding.net/u/Winddoing" target="_blank" title="Coding"><i class="fa fa-fw fa-codiepie"></i> Coding</a></span><span class="links-of-author-item"><a href="mailto:winddoing@sina.cn" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span><span class="links-of-author-item"><a href="https://stackoverflow.com/users/9567361/winddoing" target="_blank" title="StackOverflow"><i class="fa fa-fw fa-stack-overflow"></i> StackOverflow</a></span><span class="links-of-author-item"><a href="https://travis-ci.org/Winddoing/Winddoing.github.io" target="_blank" title="Travis CI"><i class="fa fa-fw fa-terminal"></i> Travis CI</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-block"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-link"></i> Links</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"> <a href="https://winddoing.gitbooks.io/embedded_notes/content/" title="嵌入式相关" target="_blank">嵌入式相关</a></li><li class="links-of-blogroll-item"> <a href="http://blog.csdn.net/sdreamq" title="CSDN" target="_blank">CSDN</a></li><li class="links-of-blogroll-item"> <a href="http://www.wowotech.net/" title="蜗窝科技" target="_blank">蜗窝科技</a></li><li class="links-of-blogroll-item"> <a href="https://blog.csdn.net/xiongxianze" title="xiongxianze" target="_blank">xiongxianze</a></li></ul><div id="days"></div><script>function show_date_time(){window.setTimeout("show_date_time()",1e3),BirthDay=new Date("02/26/2014 15:00:00"),today=new Date,timeold=today.getTime()-BirthDay.getTime(),sectimeold=timeold/1e3,secondsold=Math.floor(sectimeold),msPerDay=864e5,e_daysold=timeold/msPerDay,daysold=Math.floor(e_daysold),e_hrsold=24*(e_daysold-daysold),hrsold=setzero(Math.floor(e_hrsold)),e_minsold=60*(e_hrsold-hrsold),minsold=setzero(Math.floor(60*(e_hrsold-hrsold))),seconds=setzero(Math.floor(60*(e_minsold-minsold))),document.getElementById("days").innerHTML="已运行"+daysold+"天"+hrsold+"小时"+minsold+"分"+seconds+"秒"}function setzero(e){return e<10&&(e="0"+e),e}show_date_time()</script></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#温故而知新"><span class="nav-number">1.</span> <span class="nav-text">温故而知新</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#内存不够怎么办"><span class="nav-number">1.1.</span> <span class="nav-text">内存不够怎么办</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#隔离"><span class="nav-number">1.2.</span> <span class="nav-text">隔离</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#分段-Segmentation"><span class="nav-number">1.2.1.</span> <span class="nav-text">分段(Segmentation)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分页-Paging"><span class="nav-number">1.2.2.</span> <span class="nav-text">分页(Paging)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Page-Fault"><span class="nav-number">1.2.2.1.</span> <span class="nav-text">Page Fault</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#页映射–数据保护"><span class="nav-number">1.2.2.2.</span> <span class="nav-text">页映射–数据保护</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#MMU-Memory-Management-Unit"><span class="nav-number">1.2.2.3.</span> <span class="nav-text">MMU (Memory Management Unit)</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#线程-–-Thread"><span class="nav-number">1.3.</span> <span class="nav-text">线程 – Thread</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#线程的访问权限"><span class="nav-number">1.3.1.</span> <span class="nav-text">线程的访问权限</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#线程调度"><span class="nav-number">1.3.2.</span> <span class="nav-text">线程调度</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#线程安全"><span class="nav-number">1.3.3.</span> <span class="nav-text">线程安全</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#竞争与原子操作"><span class="nav-number">1.3.3.1.</span> <span class="nav-text">竞争与原子操作</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#锁与同步"><span class="nav-number">1.3.3.2.</span> <span class="nav-text">锁与同步</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#可重入-Reentrant-与线程安全"><span class="nav-number">1.3.4.</span> <span class="nav-text">可重入(Reentrant)与线程安全</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#过度优化"><span class="nav-number">1.3.5.</span> <span class="nav-text">过度优化</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#静态链接"><span class="nav-number">2.</span> <span class="nav-text">静态链接</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#GCC编译过程"><span class="nav-number">2.1.</span> <span class="nav-text">GCC编译过程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#预编译-Prepressing"><span class="nav-number">2.1.1.</span> <span class="nav-text">预编译-Prepressing</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#编译-Compilation"><span class="nav-number">2.1.2.</span> <span class="nav-text">编译-Compilation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#汇编-Assembly"><span class="nav-number">2.1.3.</span> <span class="nav-text">汇编-Assembly</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#链接-Linking"><span class="nav-number">2.1.4.</span> <span class="nav-text">链接-Linking</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#示例-Gcc-7-3-0"><span class="nav-number">2.1.5.</span> <span class="nav-text">示例: Gcc 7.3.0</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#目标文件–Object-File"><span class="nav-number">2.2.</span> <span class="nav-text">目标文件–Object File</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#文件格式-ELF"><span class="nav-number">2.2.1.</span> <span class="nav-text">文件格式-ELF</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ELF的格式"><span class="nav-number">2.2.2.</span> <span class="nav-text">ELF的格式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#数据和指令分段的好处"><span class="nav-number">2.2.3.</span> <span class="nav-text">数据和指令分段的好处</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#挖掘SimpleSection-o"><span class="nav-number">2.3.</span> <span class="nav-text">挖掘SimpleSection.o</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ELF的结构"><span class="nav-number">2.3.1.</span> <span class="nav-text">ELF的结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#代码段"><span class="nav-number">2.3.2.</span> <span class="nav-text">代码段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#数据段和只读数据段"><span class="nav-number">2.3.3.</span> <span class="nav-text">数据段和只读数据段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BBS段"><span class="nav-number">2.3.4.</span> <span class="nav-text">BBS段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#其他段"><span class="nav-number">2.3.5.</span> <span class="nav-text">其他段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#自定义段"><span class="nav-number">2.3.6.</span> <span class="nav-text">自定义段</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ELF文件结构描述"><span class="nav-number">2.4.</span> <span class="nav-text">ELF文件结构描述</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#头文件"><span class="nav-number">2.4.1.</span> <span class="nav-text">头文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#段表"><span class="nav-number">2.4.2.</span> <span class="nav-text">段表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#字符串表"><span class="nav-number">2.4.3.</span> <span class="nav-text">字符串表</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#链接的接口–符号"><span class="nav-number">2.5.</span> <span class="nav-text">链接的接口–符号</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#特殊符号"><span class="nav-number">2.5.1.</span> <span class="nav-text">特殊符号</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#extern-“C”"><span class="nav-number">2.5.2.</span> <span class="nav-text">extern “C”</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#弱符号和强符号"><span class="nav-number">2.5.3.</span> <span class="nav-text">弱符号和强符号</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#弱符号的定义"><span class="nav-number">2.5.3.1.</span> <span class="nav-text">弱符号的定义</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#链接器的处理规则"><span class="nav-number">2.5.3.2.</span> <span class="nav-text">链接器的处理规则</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#强引用-Strong-Reference-和弱引用-Weak-Reference"><span class="nav-number">2.5.4.</span> <span class="nav-text">强引用(Strong Reference)和弱引用(Weak Reference)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#静态链接-1"><span class="nav-number">2.6.</span> <span class="nav-text">静态链接</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#装载与动态链接"><span class="nav-number">3.</span> <span class="nav-text">装载与动态链接</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#库与运行库"><span class="nav-number">4.</span> <span class="nav-text">库与运行库</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#工具"><span class="nav-number">5.</span> <span class="nav-text">工具</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#objdump"><span class="nav-number">5.1.</span> <span class="nav-text">objdump</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#objcopy"><span class="nav-number">5.2.</span> <span class="nav-text">objcopy</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#readelf"><span class="nav-number">5.3.</span> <span class="nav-text">readelf</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#nm"><span class="nav-number">5.4.</span> <span class="nav-text">nm</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#strip"><span class="nav-number">5.5.</span> <span class="nav-text">strip</span></a></li></ol></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; 2014 &mdash; <span itemprop="copyrightYear">2019</span><span class="with-love" id="heart"><i class="fa fa-heartbeat"></i></span> <span class="author" itemprop="copyrightHolder">Winddoing</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-area-chart"></i></span> <span class="post-meta-item-text">全站共计字数&#58;</span> <span title="全站共计字数">141.7k</span></div><div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div> <span class="post-meta-divider">|</span><div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="site-uv"><i class="fa fa-user"></i><span class="busuanzi-value" id="busuanzi_value_site_uv"></span></span><span class="site-pv"><i class="fa fa-eye"></i><span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span></div><div style="display:inline"><script type="text/javascript">var cnzz_protocol="https:"==document.location.protocol?" https://":" http://";document.write(unescape("%3Cspan id='cnzz_stat_icon_1254703532'%3E%3C/span%3E%3Cscript src='"+cnzz_protocol+"s95.cnzz.com/z_stat.php%3Fid%3D1254703532%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"))</script></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script><script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script><script>AV.initialize("Q8qpjA3fOO7FEUBqcmcQFptF-gzGzoHsz","tgUTq5bX3fVmn916EMRe65eJ")</script><script>function showTime(e){var t=new AV.Query(e),c=[],u=$(".leancloud_visitors");u.each(function(){c.push($(this).attr("id").trim())}),t.containedIn("url",c),t.find().done(function(e){var t=".leancloud-visitors-count";if(0!==e.length){for(var n=0;n<e.length;n++){var o=e[n],i=o.get("url"),s=o.get("time"),r=document.getElementById(i);$(r).find(t).text(s)}for(n=0;n<c.length;n++){i=c[n],r=document.getElementById(i);var l=$(r).find(t);""==l.text()&&l.text(0)}}else u.find(t).text(0)}).fail(function(e,t){console.log("Error: "+t.code+" "+t.message)})}function addCount(i){var e=$(".leancloud_visitors"),s=e.attr("id").trim(),r=e.attr("data-flag-title").trim(),t=new AV.Query(i);t.equalTo("url",s),t.find({success:function(e){if(0<e.length){var t=e[0];t.fetchWhenSave(!0),t.increment("time"),t.save(null,{success:function(e){$(document.getElementById(s)).find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to save Visitor num, with error message: "+t.message)}})}else{var n=new i,o=new AV.ACL;o.setPublicReadAccess(!0),o.setPublicWriteAccess(!0),n.setACL(o),n.set("title",r),n.set("url",s),n.set("time",1),n.save(null,{success:function(e){$(document.getElementById(s)).find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to create")}})}},error:function(e){console.log("Error:"+e.code+" "+e.message)}})}$(function(){var e=AV.Object.extend("Counter");1==$(".leancloud_visitors").length?addCount(e):1<$(".post-title-link").length&&showTime(e)})</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script><script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script><script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script><script type="text/javascript" src="/js/src/exturl.js?v=5.1.4"></script></body></html>